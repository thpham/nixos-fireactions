name: Runner Information

on:
  workflow_dispatch:
    inputs:
      runner_size:
        description: "Runner size to test"
        required: true
        default: "small"
        type: choice
        options:
          - small
          - medium
          - large

jobs:
  runner-info:
    name: Collect Runner Information
    runs-on:
      - self-hosted
      - fireactions
      - linux
      - ${{ inputs.runner_size }}

    steps:
      - name: Runner Context
        run: |
          echo "## Runner Context" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ toJSON(runner) }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: System Information
        run: |
          echo "=== Hostname ==="
          hostname

          echo ""
          echo "=== OS Release ==="
          cat /etc/os-release

          echo ""
          echo "=== Kernel ==="
          uname -a

          echo ""
          echo "=== CPU Info ==="
          lscpu | head -20

          echo ""
          echo "=== Memory ==="
          free -h

          echo ""
          echo "=== Disk Space ==="
          df -h

          echo ""
          echo "=== Network Interfaces ==="
          ip addr show

          echo ""
          echo "=== DNS Resolution ==="
          cat /etc/resolv.conf

          echo ""
          echo "=== Environment Variables ==="
          env | sort | grep -E '^(RUNNER_|GITHUB_|HOME|PATH|USER)' || true

      - name: Docker Status
        run: |
          echo "=== Docker Version ==="
          docker --version || echo "Docker not available"

          echo ""
          echo "=== Docker Info ==="
          docker info 2>/dev/null || echo "Docker daemon not running"

      - name: Runner Tools
        run: |
          echo "=== Available Tools ==="
          echo "Git: $(git --version 2>/dev/null || echo 'not found')"
          echo "Curl: $(curl --version 2>/dev/null | head -1 || echo 'not found')"
          echo "Wget: $(wget --version 2>/dev/null | head -1 || echo 'not found')"
          echo "Jq: $(jq --version 2>/dev/null || echo 'not found')"
          echo "Node: $(node --version 2>/dev/null || echo 'not found')"
          echo "Python: $(python3 --version 2>/dev/null || echo 'not found')"
          echo "Go: $(go version 2>/dev/null || echo 'not found')"
          echo "Nix: $(nix --version 2>/dev/null || echo 'not found')"

      - name: Runner Performance Test
        run: |
          echo "=== Simple Performance Test ==="

          echo "CPU benchmark (calculating primes):"
          time (for i in $(seq 1 1000); do factor $i > /dev/null; done)

          echo ""
          echo "Disk write test:"
          time dd if=/dev/zero of=/tmp/testfile bs=1M count=100 conv=fdatasync 2>&1
          rm -f /tmp/testfile

          echo ""
          echo "Network test (ping GitHub):"
          ping -c 3 github.com || echo "Ping failed"

      - name: GitHub API Access Test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== GitHub API Test ==="
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
            https://api.github.com/rate_limit | jq '.rate' || echo "API test failed"

      - name: MMDS Metadata Debug
        run: |
          echo "=== MMDS Metadata Debug ==="
          echo "Checking what's available in MMDS..."

          echo ""
          echo "--- /latest/ ---"
          curl -sf http://169.254.169.254/latest/ 2>/dev/null || echo "Failed to fetch /latest/"

          echo ""
          echo "--- /latest/meta-data/ ---"
          curl -sf http://169.254.169.254/latest/meta-data/ 2>/dev/null || echo "Failed to fetch meta-data"

          echo ""
          echo "--- All meta-data keys ---"
          for key in $(curl -sf http://169.254.169.254/latest/meta-data/ 2>/dev/null); do
            echo "  $key: $(curl -sf http://169.254.169.254/latest/meta-data/$key 2>/dev/null | head -c 100)"
          done

          echo ""
          echo "--- Checking runner_id paths ---"
          echo "  /latest/meta-data/runner_id: $(curl -sf http://169.254.169.254/latest/meta-data/runner_id 2>/dev/null || echo 'not found')"
          echo "  /latest/meta-data/fireactions/runner_id: $(curl -sf http://169.254.169.254/latest/meta-data/fireactions/runner_id 2>/dev/null || echo 'not found')"
          echo "  /latest/meta-data/instance-id: $(curl -sf http://169.254.169.254/latest/meta-data/instance-id 2>/dev/null || echo 'not found')"

      - name: Cloud-Init Status
        run: |
          echo "=== Cloud-Init Status ==="

          echo ""
          echo "--- Cloud-Init Version ---"
          cloud-init --version 2>/dev/null || echo "cloud-init not installed"

          echo ""
          echo "--- Cloud-Init Status ---"
          cloud-init status --long 2>/dev/null || echo "Could not get status"

          echo ""
          echo "--- Cloud-Init Modules Ran ---"
          cat /run/cloud-init/status.json 2>/dev/null | jq '.v1 | to_entries[] | select(.value.errors != null and (.value.errors | length > 0)) | {stage: .key, errors: .value.errors}' 2>/dev/null || echo "No errors or status not available"

          echo ""
          echo "--- User-Data Received ---"
          if [ -f /var/lib/cloud/instance/user-data.txt ]; then
            echo "User-data file exists, first 50 lines:"
            sudo head -50 /var/lib/cloud/instance/user-data.txt
          else
            echo "No user-data file found"
          fi

          echo ""
          echo "--- CA Certificates Directory ---"
          echo "Contents of /usr/local/share/ca-certificates/:"
          ls -la /usr/local/share/ca-certificates/ 2>/dev/null || echo "Directory empty or doesn't exist"

          echo ""
          echo "--- Cloud-Init ca_certs Log ---"
          grep -i "ca.certs\|ca_certs\|certificate" /var/log/cloud-init.log 2>/dev/null | tail -20 || echo "No ca_certs entries found"

          echo ""
          echo "--- Cloud-Init resolv_conf Log ---"
          grep -i "resolv" /var/log/cloud-init.log 2>/dev/null | tail -10 || echo "No resolv_conf entries found"

      - name: Registry Cache Validation
        run: |
          echo "=== Registry Cache Validation ==="

          echo ""
          echo "--- DNS Configuration ---"
          echo "resolv.conf contents:"
          cat /etc/resolv.conf

          echo ""
          echo "--- DNS Resolution Test ---"
          echo "Resolving ghcr.io:"
          nslookup ghcr.io || dig ghcr.io +short || host ghcr.io || echo "DNS lookup tools not available"

          echo ""
          echo "Resolving docker.io:"
          nslookup docker.io || dig docker.io +short || host docker.io || echo "DNS lookup tools not available"

          echo ""
          echo "--- CA Certificate Check ---"
          echo "Fireactions Registry Cache CA:"
          # Check for certificate file written by cloud-init ca_certs module
          # ca_certs writes to /usr/local/share/ca-certificates/cloud-init-ca-cert-*.crt
          CA_CERT=$(ls /usr/local/share/ca-certificates/cloud-init-ca-cert-*.crt 2>/dev/null | head -1)
          if [ -n "$CA_CERT" ]; then
            echo "✅ CA certificate file exists: $CA_CERT"
            echo "Certificate subject:"
            openssl x509 -in "$CA_CERT" -noout -subject 2>/dev/null || echo "  (could not parse)"
          else
            echo "⚠️ CA certificate file NOT found at /usr/local/share/ca-certificates/cloud-init-ca-cert-*.crt"
            echo "  This means cloud-init ca_certs module hasn't run yet or registry-cache is not enabled"
            echo "  Contents of /usr/local/share/ca-certificates/:"
            ls -la /usr/local/share/ca-certificates/ 2>/dev/null || echo "  (directory doesn't exist)"
          fi

          echo ""
          echo "--- HTTPS Connectivity Test ---"
          echo "Testing HTTPS to ghcr.io (should work if CA cert is installed):"
          # Check HTTP status code, not just curl exit code
          # 200/401 = working (registry responds), 503 = proxy error, SSL errors = CA cert issue
          HTTP_CODE=$(curl -sS --connect-timeout 10 -o /dev/null -w "%{http_code}" https://ghcr.io/v2/ 2>&1) || true
          echo "HTTP Status: $HTTP_CODE"
          case "$HTTP_CODE" in
            200|401)
              echo "✅ HTTPS connection to ghcr.io working (registry responded)"
              ;;
            503)
              echo "❌ HTTP 503 - Proxy/upstream error (Squid may have issues)"
              ;;
            000)
              echo "❌ Connection failed - likely SSL/TLS error (CA cert not trusted?)"
              curl -sS --connect-timeout 5 https://ghcr.io/v2/ 2>&1 | head -3 || true
              ;;
            *)
              echo "⚠️ Unexpected HTTP status: $HTTP_CODE"
              ;;
          esac

          echo ""
          echo "Testing HTTPS to registry-1.docker.io:"
          HTTP_CODE=$(curl -sS --connect-timeout 10 -o /dev/null -w "%{http_code}" https://registry-1.docker.io/v2/ 2>&1) || true
          echo "HTTP Status: $HTTP_CODE"
          case "$HTTP_CODE" in
            200|401)
              echo "✅ HTTPS connection to docker.io working (401 is expected without auth)"
              ;;
            503)
              echo "❌ HTTP 503 - Proxy/upstream error"
              ;;
            000)
              echo "❌ Connection failed - likely SSL/TLS error"
              ;;
            *)
              echo "⚠️ Unexpected HTTP status: $HTTP_CODE"
              ;;
          esac

      - name: Docker Pull Test (Cache Validation)
        run: |
          echo "=== Docker Pull Test ==="

          echo ""
          echo "--- Pulling small test image ---"
          echo "First pull (should go through cache if configured):"
          time docker pull alpine:latest

          echo ""
          echo "--- Docker image info ---"
          docker images alpine:latest

          echo ""
          echo "--- Running container test ---"
          docker run --rm alpine:latest echo "✅ Container execution successful"

          echo ""
          echo "--- Cleanup ---"
          docker rmi alpine:latest || true

      - name: Registry Cache Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Registry Cache Status" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check DNS nameserver
          if grep -q "10.200.0.1" /etc/resolv.conf 2>/dev/null; then
            echo "| DNS Nameserver | ✅ Points to host (10.200.0.1) |" >> $GITHUB_STEP_SUMMARY
          else
            NS=$(grep nameserver /etc/resolv.conf | head -1 | awk '{print $2}')
            echo "| DNS Nameserver | ⚠️ Using $NS |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check CA certificate (ca_certs module writes to cloud-init-ca-cert-*.crt)
          if ls /usr/local/share/ca-certificates/cloud-init-ca-cert-*.crt >/dev/null 2>&1; then
            echo "| CA Certificate | ✅ Installed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| CA Certificate | ❌ Not found |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check HTTPS connectivity (check HTTP status code, not just curl exit)
          HTTP_CODE=$(curl -sS --connect-timeout 5 -o /dev/null -w "%{http_code}" https://ghcr.io/v2/ 2>&1) || true
          case "$HTTP_CODE" in
            200|401)
              echo "| HTTPS to ghcr.io | ✅ Working |" >> $GITHUB_STEP_SUMMARY
              ;;
            503)
              echo "| HTTPS to ghcr.io | ❌ Proxy error (503) |" >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "| HTTPS to ghcr.io | ⚠️ Status: $HTTP_CODE |" >> $GITHUB_STEP_SUMMARY
              ;;
          esac

          # Check Docker pull
          if docker pull hello-world >/dev/null 2>&1; then
            echo "| Docker Pull | ✅ Working |" >> $GITHUB_STEP_SUMMARY
            docker rmi hello-world >/dev/null 2>&1 || true
          else
            echo "| Docker Pull | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## System Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Hostname | $(hostname) |" >> $GITHUB_STEP_SUMMARY
          echo "| OS | $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '"') |" >> $GITHUB_STEP_SUMMARY
          echo "| Kernel | $(uname -r) |" >> $GITHUB_STEP_SUMMARY
          echo "| CPUs | $(nproc) |" >> $GITHUB_STEP_SUMMARY
          echo "| Memory | $(free -h | awk '/^Mem:/ {print $2}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Disk | $(df -h / | awk 'NR==2 {print $2}') |" >> $GITHUB_STEP_SUMMARY
          echo "| Runner Size | ${{ inputs.runner_size }} |" >> $GITHUB_STEP_SUMMARY
