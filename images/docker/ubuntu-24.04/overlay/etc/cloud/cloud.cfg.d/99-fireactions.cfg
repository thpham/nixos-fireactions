# Firecracker MMDS datasource configuration for cloud-init
#
# This configuration enables cloud-init to:
# 1. Fetch user-data from Firecracker's MMDS (EC2-compatible metadata service)
# 2. Install CA certificates (for registry cache MITM proxy)
# 3. Configure DNS resolver (for registry DNS interception)
#
# The user-data is provided by the host via MMDS at 169.254.169.254

# Use EC2 datasource (MMDS is EC2-compatible)
datasource_list: [Ec2, None]

datasource:
  Ec2:
    # MMDS endpoint (pre-configured in /etc/hosts as metadata.fireactions.internal)
    metadata_urls: ['http://169.254.169.254']
    # Timeouts for metadata fetch
    max_wait: 10
    timeout: 5
    # Disable IMDSv2 - Firecracker MMDS is now configured for V1
    # V1 uses simple GET requests without token authentication
    imdsv2_enable: false
    # Don't try to apply network config from metadata - VMs use kernel IP autoconfiguration
    # This suppresses: DataSourceEc2.py[WARNING]: Metadata 'network' key not valid: None
    apply_network_config: false
    # Suppress "not running on EC2" warning - we know this is Firecracker MMDS
    strict_id: false

# Modules to run during cloud-init phases
# These run BEFORE docker.service starts (cloud-init.target is before multi-user.target)

# Init stage - keep minimal, let defaults handle bootcmd/growpart/etc
cloud_init_modules:
  - seed_random
  - growpart
  - resizefs

# Config stage - this is where ca_certs and resolv_conf are designed to run
cloud_config_modules:
  # Install CA certificates from user-data (must run before Docker)
  - ca_certs
  # Configure /etc/resolv.conf from user-data
  - resolv_conf
  # Run custom commands (e.g., set hostname from runner_id)
  - runcmd

# Final modules (run after all other modules)
cloud_final_modules: []

# System info
system_info:
  distro: ubuntu
  default_user:
    name: runner
    lock_passwd: true
    gecos: GitHub Actions Runner
    groups: [docker, sudo]
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash
