# Firecracker MMDS datasource configuration for cloud-init
#
# This configuration enables cloud-init to:
# 1. Fetch user-data from Firecracker's MMDS (EC2-compatible metadata service)
# 2. Install CA certificates (for registry cache MITM proxy)
# 3. Configure DNS resolver (for registry DNS interception)
#
# The user-data is provided by the host via MMDS at 169.254.169.254

# Use EC2 datasource (MMDS is EC2-compatible)
datasource_list: [Ec2, None]

datasource:
  Ec2:
    # MMDS endpoint (pre-configured in /etc/hosts as metadata.fireactions.internal)
    metadata_urls: ['http://169.254.169.254']
    # Timeouts for metadata fetch
    max_wait: 10
    timeout: 5
    # Disable IMDSv2 - Firecracker MMDS is now configured for V1
    # V1 uses simple GET requests without token authentication
    imdsv2_enable: false

# Modules to run during cloud-init phases
# These run BEFORE docker.service starts

cloud_init_modules:
  # Install CA certificates from user-data
  - ca_certs
  # Configure /etc/resolv.conf from user-data
  - resolv_conf

cloud_config_modules:
  # Allow running custom commands if needed
  - runcmd

# Final modules (run after all other modules)
cloud_final_modules: []

# System info
system_info:
  distro: ubuntu
  default_user:
    name: runner
    lock_passwd: true
    gecos: GitHub Actions Runner
    groups: [docker, sudo]
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash
