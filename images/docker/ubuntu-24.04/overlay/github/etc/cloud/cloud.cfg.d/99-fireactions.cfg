# Firecracker MMDS datasource configuration for cloud-init
#
# This configuration enables cloud-init to:
# 1. Fetch user-data from Firecracker's MMDS (EC2-compatible metadata service)
# 2. Install CA certificates (for registry cache MITM proxy)
# 3. Configure DNS via runcmd (resolv_conf module doesn't work with systemd-resolved)
#
# The user-data is provided by the host via MMDS at 169.254.169.254

# CRITICAL: Add route to MMDS endpoint before cloud-init tries to fetch metadata
# Firecracker MMDS requires an explicit route in the guest OS:
#   "guest applications must insert a new rule into the routing table"
#   See: https://github.com/firecracker-microvm/firecracker/blob/main/docs/mmds/mmds-user-guide.md
# We use cloud-init's bootcmd to ensure the route exists before metadata fetch
bootcmd:
  - ip route add 169.254.169.254 dev eth0

# Use EC2 datasource (MMDS is EC2-compatible)
datasource_list: [Ec2, None]

datasource:
  Ec2:
    # MMDS endpoint (pre-configured in /etc/hosts as metadata.fireactions.internal)
    metadata_urls: ['http://169.254.169.254']
    # Timeouts for metadata fetch
    max_wait: 10
    timeout: 5
    # Disable IMDSv2 - Firecracker MMDS is now configured for V1
    # V1 uses simple GET requests without token authentication
    imdsv2_enable: false
    # Don't try to apply network config from metadata - VMs use kernel IP autoconfiguration
    # This suppresses: DataSourceEc2.py[WARNING]: Metadata 'network' key not valid: None
    apply_network_config: false
    # Suppress "not running on EC2" warning - we know this is Firecracker MMDS
    strict_id: false

# System info
system_info:
  distro: ubuntu
  default_user:
    name: runner
    lock_passwd: true
    gecos: GitHub Actions Runner
    groups: [docker, sudo]
    sudo: ["ALL=(ALL) NOPASSWD:ALL"]
    shell: /bin/bash
